{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Edit Product - Absolute Sports</title>
{% endblock meta %}

{% block content %}
<div class="bg-gray-900 w-full min-h-screen">
  <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Back Navigation -->
    <div class="mb-6">
      <a href="{% url 'main:show_main' %}" class="text-gray-300 hover:text-white font-medium transition-colors flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
        Back to Products
      </a>
    </div>
    
    <!-- Form Container -->
    <div class="bg-gray-800 rounded-xl border border-gray-700 shadow-2xl overflow-hidden">
      <!-- Header -->
      <div class="bg-gradient-to-r from-purple-600 to-purple-700 px-6 py-8 sm:px-8">
        <div class="flex items-center gap-3">
          <div class="bg-white bg-opacity-20 rounded-lg p-3">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-white">Edit Product</h1>
            <p class="text-purple-100 opacity-90">Update your football product details</p>
          </div>
        </div>
      </div>

      <!-- Form Body -->
      <div class="p-6 sm:p-8">
        <form method="POST" id="editProductForm" class="space-y-6">
          {% csrf_token %}
          
          <!-- Product Name -->
          <div>
            <label for="id_name" class="block text-sm font-semibold text-gray-200 mb-3">
              Product Name <span class="text-red-400">*</span>
            </label>
            <input type="text" name="name" value="{{ form.name.value|default:'' }}" 
                   class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" 
                   placeholder="Enter product name" required>
            <div class="error-message text-red-400 text-sm mt-2 hidden"></div>
          </div>

          <!-- Description -->
          <div>
            <label for="id_description" class="block text-sm font-semibold text-gray-200 mb-3">
              Description <span class="text-red-400">*</span>
            </label>
            <textarea name="description" rows="4" 
                      class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200 resize-none" 
                      placeholder="Describe your product..." required>{{ form.description.value|default:'' }}</textarea>
            <div class="error-message text-red-400 text-sm mt-2 hidden"></div>
          </div>

          <!-- Category -->
          <div>
            <label for="id_category" class="block text-sm font-semibold text-gray-200 mb-3">
              Category <span class="text-red-400">*</span>
            </label>
            <select name="category" 
                    class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" required>
              <option value="" disabled>Select a category</option>
              <option value="Jerseys" {% if form.category.value == 'Jerseys' %}selected{% endif %}>Jerseys</option>
              <option value="Boots" {% if form.category.value == 'Boots' %}selected{% endif %}>Boots</option>
              <option value="Balls" {% if form.category.value == 'Balls' %}selected{% endif %}>Balls</option>
              <option value="Training" {% if form.category.value == 'Training' %}selected{% endif %}>Training Equipment</option>
              <option value="Accessories" {% if form.category.value == 'Accessories' %}selected{% endif %}>Accessories</option>
            </select>
            <div class="error-message text-red-400 text-sm mt-2 hidden"></div>
          </div>

          <!-- Price -->
          <div>
            <label for="id_price" class="block text-sm font-semibold text-gray-200 mb-3">
              Price (IDR) <span class="text-red-400">*</span>
            </label>
            <div class="relative">
              <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400">Rp</span>
              <input type="number" name="price" value="{{ form.price.value|default:'' }}" 
                     class="w-full pl-12 pr-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" 
                     placeholder="0" min="0" step="1000" required>
            </div>
            <div class="error-message text-red-400 text-sm mt-2 hidden"></div>
          </div>

          <!-- Thumbnail URL -->
          <div>
            <label for="id_thumbnail" class="block text-sm font-semibold text-gray-200 mb-3">
              Product Image URL
            </label>
            <input type="url" name="thumbnail" value="{{ form.thumbnail.value|default:'' }}" 
                   class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" 
                   placeholder="https://example.com/image.jpg">
            <p class="text-gray-400 text-sm mt-2">Optional: Add an image URL to showcase your product</p>
            <div class="error-message text-red-400 text-sm mt-2 hidden"></div>
          </div>

          <!-- Action Buttons -->
          <div class="flex flex-col sm:flex-row gap-4 pt-8 border-t border-gray-700">
            <a href="{% url 'main:show_main' %}" 
               class="order-2 sm:order-1 px-6 py-3 border border-gray-600 text-gray-300 rounded-lg font-medium hover:bg-gray-700 hover:border-gray-500 transition-all duration-200 text-center">
              Cancel
            </a>
            <button type="submit" 
                    class="order-1 sm:order-2 flex-1 bg-gradient-to-r from-purple-600 to-purple-700 text-white px-6 py-3 rounded-lg font-medium hover:from-purple-700 hover:to-purple-800 transition-all duration-200 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed">
              <span class="flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Update Product
              </span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Include Toast -->
{% include 'toast.html' %}

<script src="{% static 'js/toast.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('editProductForm');
    const submitButton = form.querySelector('button[type="submit"]');
    const originalButtonText = submitButton.innerHTML;

    // Form validation
    function validateForm() {
        let isValid = true;
        const inputs = form.querySelectorAll('input[required], textarea[required], select[required]');
        
        inputs.forEach(input => {
            const errorElement = input.parentElement.querySelector('.error-message') || 
                               input.parentElement.parentElement.querySelector('.error-message');
            
            if (!input.value.trim()) {
                errorElement.textContent = `${input.previousElementSibling.textContent.replace(' *', '')} is required`;
                errorElement.classList.remove('hidden');
                input.classList.add('border-red-500');
                isValid = false;
            } else {
                errorElement.classList.add('hidden');
                input.classList.remove('border-red-500');
                
                // Additional validation for specific fields
                if (input.name === 'price' && (isNaN(input.value) || parseFloat(input.value) <= 0)) {
                    errorElement.textContent = 'Price must be a positive number';
                    errorElement.classList.remove('hidden');
                    input.classList.add('border-red-500');
                    isValid = false;
                } else if (input.name === 'thumbnail' && input.value && !isValidURL(input.value)) {
                    errorElement.textContent = 'Please enter a valid URL';
                    errorElement.classList.remove('hidden');
                    input.classList.add('border-red-500');
                    isValid = false;
                }
            }
        });
        
        return isValid;
    }

    function isValidURL(string) {
        try {
            new URL(string);
            return true;
        } catch (_) {
            return false;
        }
    }

    // Real-time validation
    form.querySelectorAll('input, textarea, select').forEach(input => {
        input.addEventListener('blur', function() {
            const errorElement = this.parentElement.querySelector('.error-message') || 
                               this.parentElement.parentElement.querySelector('.error-message');
            
            if (this.hasAttribute('required') && !this.value.trim()) {
                errorElement.textContent = `${this.previousElementSibling.textContent.replace(' *', '')} is required`;
                errorElement.classList.remove('hidden');
                this.classList.add('border-red-500');
            } else {
                errorElement.classList.add('hidden');
                this.classList.remove('border-red-500');
            }
        });

        input.addEventListener('input', function() {
            if (this.classList.contains('border-red-500')) {
                this.classList.remove('border-red-500');
                const errorElement = this.parentElement.querySelector('.error-message') || 
                                   this.parentElement.parentElement.querySelector('.error-message');
                errorElement.classList.add('hidden');
            }
        });
    });

    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!validateForm()) {
            showErrorToast('Please fix the errors above');
            return;
        }

        // Update button state
        submitButton.disabled = true;
        submitButton.innerHTML = `
            <span class="flex items-center justify-center gap-2">
                <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Updating...
            </span>
        `;

        // Submit the form
        fetch(form.action || window.location.href, {
            method: 'POST',
            body: new FormData(form),
            headers: {
                'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
            }
        }).then(response => {
            if (response.ok) {
                showSuccessToast('Product updated successfully!');
                setTimeout(() => {
                    window.location.href = "{% url 'main:show_main' %}";
                }, 1500);
            } else {
                throw new Error('Failed to update product');
            }
        }).catch(error => {
            console.error('Error:', error);
            showErrorToast('Failed to update product. Please try again.');
            
            // Reset button state
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;
        });
    });

    // Show success message if redirected with success
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === 'true') {
        showSuccessToast('Product updated successfully!');
    }
});
</script>

{% endblock %}